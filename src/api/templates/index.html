<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–∂</title>
    <link rel="stylesheet" href="/static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    
    <div class="container">
        
        <h1>üìä –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h1>
        <p class="subtitle">
        –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–µ—Ä–∏–æ–¥ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ Excel —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º. 
        <a href="/docs-ui" style="color: #3498db; text-decoration: underline;">–°–ø—Ä–∞–≤–∫–∞</a>
        </p>

        <form id="predictForm">
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="controls">
                <button type="button" id="selectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
                <button type="button" id="deselectAll">–°–Ω—è—Ç—å –≤—Å—ë</button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ -->
            <div class="categories-grid" id="categories">
                <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>

            <!-- –î–∞—Ç—ã -->
            <div class="date-group">
                <label>
                    <span>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</span>
                    <input type="date" id="date_start" name="date_start" required>
                </label>
                <label>
                    <span>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</span>
                    <input type="date" id="date_end" name="date_end" required>
                </label>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ -->
            <button type="submit" class="submit-btn">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ (Excel)</button>

            <!-- –°—Ç–∞—Ç—É—Å -->
            <div id="status" class="status"></div>
        </form>
    </div>

    <script>
        // –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categories = [
            "00. –í–û–î–ê 19 –ª–∏—Ç—Ä–æ–≤",
            "01. –í–û–î–ê 3 - 12–ª + –ö—É–ª–µ—Ä–Ω–∞—è",
            "02. –í–û–î–ê 0,25 - 2,5–ª",
            "03. –ù–ê–ü–ò–¢–ö–ò, –°–û–ö–ò, –ö–í–ê–°",
            "04. –î–ò–°–¢–ò–õ–õ–ò–†–û–í–ê–ù–ù–ê–Ø (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –≤–æ–¥–∞)",
            "05. –ö–£–õ–ï–†–´+–ü–û–ú–ü–´+–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã",
            "06. –ü–†–û–î–£–ö–¢–´ –ü–ò–¢–ê–ù–ò–Ø (FOOD)",
            "07. –ù–ï–ü–†–û–î–û–í–û–õ–¨–°–¢–í–ï–ù–ù–´–ï –¢–û–í–ê–†–´ (NonFood)",
            "08. –ì–ò–ì–ò–ï–ù–ê –∏ –ö–û–°–ú–ï–¢–ò–ö–ê",
            "09. –ë–´–¢–û–í–ê–Ø –•–ò–ú–ò–Ø (–ü–æ—Ä—è–¥–æ–∫ –≤ –¥–æ–º–µ)",
            "10. –ê–í–¢–û—Ç–æ–≤–∞—Ä—ã",
            "11. –ë–´–¢–û–í–ê–Ø –¢–ï–•–ù–ò–ö–ê –∏ –≠–õ–ï–ö–¢–†–û–ù–ò–ö–ê",
            "12. –î–õ–Ø –®–ö–û–õ–´ –∏ –û–§–ò–°–ê",
            "13. –¢–û–í–ê–†–´ –î–õ–Ø –î–ï–¢–ï–ô",
            "14. –¢–û–í–ê–†–´ –î–õ–Ø –ñ–ò–í–û–¢–ù–´–•",
            "15. –°–ü–û–†–¢–ò–í–ù–û–ï –ü–ò–¢–ê–ù–ò–ï, –ù–ê–ü–ò–¢–ö–ò",
            "49. —è—è–¢–û–í–ê–†–û–í–ï–î - –ù–ï –¥–ª—è –ü–†–û–î–ê–ñ–ò!!!!",
            "52. –£–°–õ–£–ì–ò",
            "77. –ê–ö–¶–ò–ò –æ—Ç –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞!!!!!!!!!!!!!!",
            "88. –ò–ù–í–ï–ù–¢–ê–†–¨",
            "99. –ö–û–ú–ü–õ–ï–ö–¢–£–Æ–©–ò–ï (–Ω–µ –¥–ª—è —Å–∞–π—Ç–∞)"
        ];

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
        const container = document.getElementById("categories");
        categories.forEach(cat => {
            const div = document.createElement("label");
            div.className = "checkbox-label";
            div.innerHTML = `
                <input type="checkbox" name="category" value="${cat}">
                <span>${cat}</span>
            `;
            container.appendChild(div);
        });

        // –ö–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å—ë / –°–Ω—è—Ç—å –≤—Å—ë"
        document.getElementById("selectAll").onclick = () => {
            document.querySelectorAll('input[name="category"]').forEach(cb => cb.checked = true);
        };
        document.getElementById("deselectAll").onclick = () => {
            document.querySelectorAll('input[name="category"]').forEach(cb => cb.checked = false);
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById("predictForm").onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const selectedCategories = formData.getAll("category");

            if (selectedCategories.length === 0) {
                document.getElementById("status").innerText = "‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é";
                return;
            }

            const params = new URLSearchParams();
            selectedCategories.forEach(cat => params.append("category", cat));
            params.append("date_start", formData.get("date_start"));
            params.append("date_end", formData.get("date_end"));

            const status = document.getElementById("status");
            status.innerText = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞...";

            try {
                const response = await fetch(`/predict/excel?${params}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `–ø—Ä–æ–≥–Ω–æ–∑_–ø–æ_${selectedCategories.length}_–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    status.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω.";
                } else {
                    const errorText = await response.text();
                    status.innerText = `‚ùå –û—à–∏–±–∫–∞: ${errorText}`;
                }
            } catch (error) {
                status.innerText = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            }
        };
    </script>
</body>
</html>